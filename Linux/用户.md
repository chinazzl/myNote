# 关于用户操作

## 创建用户

```shell
# 创建node_exporter用户，不创建home目录  无法进行shell交互
 useradd --no-create-home --shell /bin/false node_exporter
```

## 删除用户
在 Linux 上删除用户通常使用命令行工具 `userdel`（适用于大多数发行版）或 `deluser`（Debian/Ubuntu 提供的友好脚本）。下面按场景给出常用方法、注意事项和示例。

重要注意事项（执行前请确认）
- 请用 root 或具有 sudo 权限的用户执行删除操作。
- 删除用户可能导致该用户拥有的文件仍留在系统中（若未使用删除家目录选项）。确认是否需要保留或删除其家目录、邮件和 crontab 等。
- 如果用户正在登录或有运行中的进程，建议先终止其进程再删除用户，避免出现文件/会话问题。

常用命令

1) 使用 userdel（通用）
- 仅删除用户账号（不删除家目录和邮件）：
  sudo userdel username
- 同时删除用户和其家目录以及邮件（推荐清理）：
  sudo userdel -r username
  - 选项说明：`-r` 会删除 /home/username（或 passwd 文件中指定的主目录）以及用户的 mail spool。
- 强制删除并移除其进程（某些实现有 -f）：
  sudo userdel -f username
  - 警告：`-f` 行为依实现不同且危险，慎用。

示例：
- 删除用户 alice 并删除其家目录：
  sudo userdel -r alice

2) 使用 deluser（Debian/Ubuntu 风格，更友好）
- 仅删除账户：
  sudo deluser username
- 删除账户及其主目录：
  sudo deluser --remove-home username
- 还可以同时删除与该用户相关的组（如果存在）：
  sudo deluser --remove-home --remove-all-files username

3) 先查看用户信息（建议）
- 查看用户条目：
  getent passwd username
- 查看用户的 home 目录和 shell：
  grep "^username:" /etc/passwd

4) 在删除前杀掉用户正在运行的进程
- 列出该用户进程：
  ps -u username
- 终止所有进程（先发送 TERM，再必要时 KILL）：
  sudo pkill -u username
  sudo pkill -9 -u username

5) 删除用户相关的 crontab、at 任务、邮件、sudo 权限等
- 删除 crontab：
  sudo crontab -r -u username
- 删除 at 任务：
  sudo atrm $(atq | awk '/^/ {print $1}')  # 或用更具体的筛选（需谨慎）
- 检查并删除该用户在 /etc/sudoers 或 /etc/sudoers.d 中的条目
- 查找并清理散落文件（如果不使用 -r）：
  sudo find / -uid UID -exec ls -ld {} \;
  或删除：
  sudo find / -uid UID -exec rm -rf {} \;

6) 删除用户同时保留 UID 对应文件（备份场景）
- 如果想删除账户但保留文件以便以后恢复，可先将家目录打包备份：
  sudo tar -czf /root/alice-home-backup.tgz /home/alice
  然后删除：
  sudo userdel alice

7) 删除用户后检查
- 确认 /etc/passwd、/etc/shadow、/etc/group 中无该用户条目：
  getent passwd | grep username
- 确认家目录已删除（如果用 -r）：
  ls -ld /home/username
- 确认没有运行进程：
  ps -u username

常见问题
- “删除后还能登录/进程仍在运行”：可能是会话未结束或进程以 PID 保留，先用 `pkill -u` 并注销会话或重启系统（在不可避免时）。
- “userdel 报错：user is currently logged in”：
  - 先查看谁在登录： `who` 或 `w`，使用 `pkill -u username` 结束进程，然后重试，或使用 `userdel -f`（谨慎）。
- “家目录未删除”：确认使用了 `-r`，且主目录路径在 /etc/passwd 中正确。

示例流程（删除 alice，彻底清理）
1. 备份家目录（可选）
   sudo tar -czf /root/alice-home-backup.tgz /home/alice
2. 结束进程
   sudo pkill -u alice
   sleep 1
   sudo pkill -9 -u alice
3. 删除 crontab
   sudo crontab -r -u alice
4. 删除用户并家目录
   sudo userdel -r alice
5. 检查并清理残留文件
   sudo find / -uid $(id -u alice 2>/dev/null) -exec ls -ld {} \;

如果你告诉我你的发行版（例如 Ubuntu 22.04、CentOS 7/8、Debian 等）和你想要“完全删除”还是“只删除账号但保留文件”，我可以给出针对性的命令和注意事项。