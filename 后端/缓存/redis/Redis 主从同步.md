## Redis 主从同步

![slave](../../assert/redisMaster-Slavepng.png)

Redis主从同步包括三个阶段。

第一阶段：主从库间建立连接、协商同步。

> - 从库向主库发送`psync` 命令，告诉它要进行数据同步。
> - 主库收到 `psync` 命令后,响应`FULLRESYNC`命令（它表示第一次复制采用的是全量复制），并带上主库`runID`和主库目前的复制进度`offset`。

第二阶段：主库把数据同步到从库，从库收到数据后，完成本地加载。

> - 主库执行`bgsave`命令，生成`RDB`文件，接着将文件发给从库。从库接收到`RDB `文件后，会先清空当前数据库，然后加载 RDB 文件。
> - 主库把数据同步到从库的过程中，新来的写操作，会记录到`replication buffer`。

第三阶段，主库把新写的命令，发送到从库。

> - 主库完成RDB发送后，会把`replication buffer`中的修改操作发给从库，从库再重新执行这些操作。这样主从库就实现同步啦。

第四阶段：slave node如果跟master node有网络故障，断开了连接，会自动重连，连接之后master node 仅会复制给slave部分缺少的数据。

### 如何保证缓存与数据库双写时的数据一致性？

| 问题场景                      | 描述                                                      | 解决                                                              |
| ------------------------- | ------------------------------------------------------- | --------------------------------------------------------------- |
| 先写缓存，再写数据库，缓存写入成功，数据库写入失败 | 缓存写入成功，但是数据库写入失败或者响应延迟，则下次读取（并发读）缓存时，就出现脏读              | 这个写缓存的方式本身就是错误的，需要改为先写数据库，把旧缓存设置为无效；读取数据的时候，如果缓存不存在，则读取数据库再写缓存。 |
| 先写数据库，再写缓存，数据库写成功，缓存写失败   | 写数据库成功，但写缓存失败，则下次读取（并发读）缓存时，则读不到数据                      | 缓存使用时，加入读缓存失败，先读数据库，再回写缓存的方式实现。                                 |
| 需要缓存异步刷新                  | 指数据库操作和写缓存不在一个操作步骤中，比如在分布式场景下，无法做到同时写缓存或需要异步刷新（补救措施）时候。 | 确定哪些数据适合此类场景，根据经验值确定合理的数据库不一致时间，用户数据刷新的时间间隔。                    |

