看到您的项目结构，我为您设计一套完整的注册功能代码，包括服务端、API、DTO等。基于您现有的认证架构，我将提供以下完整代码：

## 1. 注册相关的DTO

```java
// ali-cloud-api/src/main/java/com/alicloud/api/bean/dto/UserRegisterDto.java
package com.alicloud.api.bean.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;
import lombok.Data;

/**
 * 用户注册请求DTO
 * @author: zhaolin
 * @Date: 2025/11/23
 * @Description:
 */
@Data
public class UserRegisterDto {

    @NotBlank(message = "用户名不能为空")
    @Size(min = 4, max = 20, message = "用户名长度必须在4-20个字符之间")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "用户名只能包含字母、数字和下划线")
    private String username;

    @NotBlank(message = "密码不能为空")
    @Size(min = 6, max = 20, message = "密码长度必须在6-20个字符之间")
    @Pattern(regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)[a-zA-Z\\d@#$%^&+=]{6,20}$", 
             message = "密码必须包含大小写字母和数字")
    private String password;

    @NotBlank(message = "确认密码不能为空")
    private String confirmPassword;

    @NotBlank(message = "昵称不能为空")
    @Size(min = 2, max = 20, message = "昵称长度必须在2-20个字符之间")
    private String nickname;

    @Email(message = "邮箱格式不正确")
    private String email;

    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phoneNumber;

    private String captcha;

    private String captchaKey;

    private String clientIp;

    private String userAgent;
}
```

```java
// ali-cloud-common/src/main/java/com/alicloud/common/model/RegisterResponse.java
package com.alicloud.common.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * 注册响应结果
 * @author: zhaolin
 * @Date: 2025/11/23
 * @Description:
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class RegisterResponse {

    /**
     * 注册是否成功
     */
    private boolean success;

    /**
     * 用户ID
     */
    private Long userId;

    /**
     * 用户名
     */
    private String username;

    /**
     * 注册时间
     */
    private String registerTime;

    /**
     * 提示信息
     */
    private String message;

    /**
     * 是否需要邮箱验证
     */
    private boolean needEmailVerification;

    /**
     * 验证邮箱
     */
    private String verificationEmail;
}
```

## 2. 用户验证码服务

```java
// ali-cloud-authService/src/main/java/com/alicloud/auth/service/CaptchaService.java
package com.alicloud.auth.service;

/**
 * 验证码服务接口
 * @author: zhaolin
 * @Date: 2025/11/23
 * @Description:
 */
public interface CaptchaService {

    /**
     * 生成注册验证码
     * @param email 邮箱
     * @param captchaKey 验证码key
     * @return 验证码
     */
    String generateRegisterCaptcha(String email, String captchaKey);

    /**
     * 验证验证码
     * @param captchaKey 验证码key
     * @param captcha 用户输入的验证码
     * @return 是否验证成功
     */
    boolean validateCaptcha(String captchaKey, String captcha);

    /**
     * 生成手机验证码
     * @param phoneNumber 手机号
     * @param captchaKey 验证码key
     * @return 验证码
     */
    String generateSmsCaptcha(String phoneNumber, String captchaKey);

    /**
     * 清除验证码
     * @param captchaKey 验证码key
     */
    void clearCaptcha(String captchaKey);
}
```

```java
// ali-cloud-authService/src/main/java/com/alicloud/auth/service/impl/CaptchaServiceImpl.java
package com.alicloud.auth.service.impl;

import cn.hutool.core.util.RandomUtil;
import com.alicloud.auth.service.CaptchaService;
import com.alicloud.common.utils.RedisUtils;
import jakarta.annotation.Resource;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

import java.util.concurrent.TimeUnit;

/**
 * 验证码服务实现
 * @author: zhaolin
 * @Date: 2025/11/23
 * @Description:
 */
@Slf4j
@Service
public class CaptchaServiceImpl implements CaptchaService {

    @Resource
    private RedisUtils<String> redisUtils;

    @Resource(required = false)
    private JavaMailSender javaMailSender;

    @Value("${spring.mail.username:}")
    private String fromEmail;

    private static final String CAPTCHA_PREFIX = "captcha:register:";
    private static final int CAPTCHA_EXPIRE_MINUTES = 5;
    private static final int CAPTCHA_LENGTH = 6;

    @Override
    public String generateRegisterCaptcha(String email, String captchaKey) {
        String captcha = RandomUtil.randomNumbers(CAPTCHA_LENGTH);
        
        // 存储验证码到Redis
        String redisKey = CAPTCHA_PREFIX + captchaKey;
        redisUtils.set(redisKey, captcha, CAPTCHA_EXPIRE_MINUTES, TimeUnit.MINUTES);
        
        // 发送邮件验证码
        if (javaMailSender != null) {
            sendEmailCaptcha(email, captcha);
        } else {
            log.warn("邮件发送服务未配置，验证码: {}", captcha);
        }
        
        log.info("生成注册验证码: email={}, captchaKey={}, captcha={}", email, captchaKey, captcha);
        return captcha;
    }

    @Override
    public String generateSmsCaptcha(String phoneNumber, String captchaKey) {
        String captcha = RandomUtil.randomNumbers(CAPTCHA_LENGTH);
        
        // 存储验证码到Redis
        String redisKey = CAPTCHA_PREFIX + captchaKey;
        redisUtils.set(redisKey, captcha, CAPTCHA_EXPIRE_MINUTES, TimeUnit.MINUTES);
        
        // 发送短信验证码（需要集成短信服务）
        sendSmsCaptcha(phoneNumber, captcha);
        
        log.info("生成短信验证码: phone={}, captchaKey={}, captcha={}", phoneNumber, captchaKey, captcha);
        return captcha;
    }

    @Override
    public boolean validateCaptcha(String captchaKey, String captcha) {
        String redisKey = CAPTCHA_PREFIX + captchaKey;
        String storedCaptcha = redisUtils.get(redisKey);
        
        if (storedCaptcha == null) {
            log.warn("验证码已过期或不存在: captchaKey={}", captchaKey);
            return false;
        }
        
        boolean isValid = storedCaptcha.equalsIgnoreCase(captcha);
        if (isValid) {
            // 验证成功后清除验证码
            clearCaptcha(captchaKey);
        }
        
        return isValid;
    }

    @Override
    public void clearCaptcha(String captchaKey) {
        String redisKey = CAPTCHA_PREFIX + captchaKey;
        redisUtils.delete(redisKey);
    }

    private void sendEmailCaptcha(String email, String captcha) {
        try {
            SimpleMailMessage message = new SimpleMailMessage();
            message.setFrom(fromEmail);
            message.setTo(email);
            message.setSubject("注册验证码");
            message.setText("您的注册验证码是：" + captcha + "，有效期为" + CAPTCHA_EXPIRE_MINUTES + "分钟。");
            
            javaMailSender.send(message);
            log.info("发送邮箱验证码成功: email={}, captcha={}", email, captcha);
        } catch (Exception e) {
            log.error("发送邮箱验证码失败: email={}", email, e);
        }
    }

    private void sendSmsCaptcha(String phoneNumber, String captcha) {
        // 集成短信服务发送验证码
        // 这里可以集成阿里云短信、腾讯云短信等服务
        log.info("发送短信验证码: phone={}, captcha={}", phoneNumber, captcha);
    }
}
```

## 3. 用户注册服务

```java
// ali-cloud-api/src/main/java/com/alicloud/api/service/user/RegisterService.java
package com.alicloud.api.service.user;

import com.alicloud.api.bean.dto.UserRegisterDto;
import com.alicloud.common.model.RegisterResponse;

/**
 * 用户注册服务接口
 * @author: zhaolin
 * @Date: 2025/11/23
 * @Description:
 */
public interface RegisterService {

    /**
     * 发送注册验证码
     * @param email 邮箱
     * @param captchaKey 验证码key
     * @return 是否发送成功
     */
    boolean sendRegisterCaptcha(String email, String captchaKey);

    /**
     * 用户注册
     * @param registerDto 注册信息
     * @return 注册结果
     */
    RegisterResponse register(UserRegisterDto registerDto);

    /**
     * 验证用户名是否存在
     * @param username 用户名
     * @return 是否存在
     */
    boolean checkUsernameExists(String username);

    /**
     * 验证邮箱是否存在
     * @param email 邮箱
     * @return 是否存在
     */
    boolean checkEmailExists(String email);

    /**
     * 验证手机号是否存在
     * @param phoneNumber 手机号
     * @return 是否存在
     */
    boolean checkPhoneNumberExists(String phoneNumber);
}
```

```java
// ali-cloud-authService/src/main/java/com/alicloud/auth/service/impl/RegisterServiceImpl.java
package com.alicloud.auth.service.impl;

import cn.hutool.core.util.RandomUtil;
import cn.hutool.core.util.StrUtil;
import com.alicloud.api.bean.dto.UserRegisterDto;
import com.alicloud.api.service.user.RegisterService;
import com.alicloud.auth.service.CaptchaService;
import com.alicloud.common.exception.UserException;
import com.alicloud.common.model.RegisterResponse;
import com.alicloud.common.utils.CommonUtil;
import com.alicloud.dao.bean.User;
import com.alicloud.dao.mapper.UserMapper;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import jakarta.annotation.Resource;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.BeanUtils;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Date;
import java.util.List;

/**
 * 用户注册服务实现
 * @author: zhaolin
 * @Date: 2025/11/23
 * @Description:
 */
@Slf4j
@Service
public class RegisterServiceImpl implements RegisterService {

    @Resource
    private UserMapper userMapper;

    @Resource
    private CaptchaService captchaService;

    @Resource
    private PasswordEncoder passwordEncoder;

    @Override
    public boolean sendRegisterCaptcha(String email, String captchaKey) {
        if (StrUtil.isBlank(email) || StrUtil.isBlank(captchaKey)) {
            throw new UserException("邮箱和验证码key不能为空");
        }

        try {
            String captcha = captchaService.generateRegisterCaptcha(email, captchaKey);
            return StrUtil.isNotBlank(captcha);
        } catch (Exception e) {
            log.error("发送注册验证码失败: email={}", email, e);
            throw new UserException("发送验证码失败，请稍后重试");
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public RegisterResponse register(UserRegisterDto registerDto) {
        log.info("开始用户注册: username={}", registerDto.getUsername());

        // 1. 参数验证
        validateRegisterParams(registerDto);

        // 2. 验证用户名、邮箱、手机号是否已存在
        validateUserExists(registerDto);

        // 3. 验证验证码
        if (StrUtil.isNotBlank(registerDto.getCaptchaKey()) && StrUtil.isNotBlank(registerDto.getCaptcha())) {
            if (!captchaService.validateCaptcha(registerDto.getCaptchaKey(), registerDto.getCaptcha())) {
                throw new UserException("验证码错误或已过期");
            }
        }

        // 4. 创建用户
        User user = createUser(registerDto);

        // 5. 保存到数据库
        userMapper.insert(user);

        // 6. 构建返回结果
        RegisterResponse response = RegisterResponse.builder()
                .success(true)
                .userId(user.getId())
                .username(user.getUserName())
                .registerTime(new Date().toString())
                .message("注册成功")
                .needEmailVerification(false)
                .verificationEmail(user.getEmail())
                .build();

        log.info("用户注册成功: userId={}, username={}", user.getId(), user.getUserName());
        return response;
    }

    private void validateRegisterParams(UserRegisterDto registerDto) {
        // 验证密码和确认密码是否一致
        if (!registerDto.getPassword().equals(registerDto.getConfirmPassword())) {
            throw new UserException("两次输入的密码不一致");
        }
    }

    private void validateUserExists(UserRegisterDto registerDto) {
        // 检查用户名是否存在
        LambdaQueryWrapper<User> usernameQuery = new LambdaQueryWrapper<>();
        usernameQuery.eq(User::getUserName, registerDto.getUsername());
        User existingUser = userMapper.selectOne(usernameQuery);
        if (existingUser != null) {
            throw new UserException("用户名已存在");
        }

        // 检查邮箱是否存在
        if (StrUtil.isNotBlank(registerDto.getEmail())) {
            LambdaQueryWrapper<User> emailQuery = new LambdaQueryWrapper<>();
            emailQuery.eq(User::getEmail, registerDto.getEmail());
            User existingEmailUser = userMapper.selectOne(emailQuery);
            if (existingEmailUser != null) {
                throw new UserException("邮箱已被注册");
            }
        }

        // 检查手机号是否存在
        if (StrUtil.isNotBlank(registerDto.getPhoneNumber())) {
            LambdaQueryWrapper<User> phoneQuery = new LambdaQueryWrapper<>();
            phoneQuery.eq(User::getPhoneNumber, registerDto.getPhoneNumber());
            User existingPhoneUser = userMapper.selectOne(phoneQuery);
            if (existingPhoneUser != null) {
                throw new UserException("手机号已被注册");
            }
        }
    }

    private User createUser(UserRegisterDto registerDto) {
        User user = new User();
        
        // 基本信息
        user.setUserName(registerDto.getUsername());
        user.setNickName(registerDto.getNickname());
        user.setEmail(registerDto.getEmail());
        user.setPhoneNumber(registerDto.getPhoneNumber());
        
        // 密码加密
        String encryptedPassword = passwordEncoder.encode(registerDto.getPassword());
        user.setPassword(encryptedPassword);
        
        // 设置默认值
        user.setUserType(com.alicloud.dao.enums.UserType.NORMAL); // 普通用户
        user.setUserStatus(com.alicloud.dao.enums.UserStatus.NORMAL); // 正常状态
        user.setSex(com.alicloud.dao.enums.Sex.UNKNOWN); // 未知性别
        user.setDelFlag(com.alicloud.dao.enums.DelFlag.NO_DEL); // 未删除
        
        // 账户安全字段
        user.setAccountNonExpired(true);
        user.setAccountNonLocked(true);
        user.setCredentialsNonExpired(true);
        user.setEnabled(true);
        
        // 密码相关
        user.setPasswordSalt(CommonUtil.randomString(32));
        user.setPasswordUpdateTime(LocalDateTime.now());
        
        // 登录失败相关
        user.setLoginFailCount(0);
        user.setAccountNonLocked(false);
        user.setLockTime(null);
        user.setUnlockTime(null);
        user.setLastLoginTime(null);
        user.setLastLoginIp(null);
        
        // 创建信息
        user.setCreateBy(0L); // 系统创建
        user.setCreateTime(new Date());
        user.setUpdateBy(0L);
        user.setUpdateTime(new Date());
        
        return user;
    }

    @Override
    public boolean checkUsernameExists(String username) {
        if (StrUtil.isBlank(username)) {
            return false;
        }
        
        LambdaQueryWrapper<User> query = new LambdaQueryWrapper<>();
        query.eq(User::getUserName, username);
        query.eq(User::getDelFlag, com.alicloud.dao.enums.DelFlag.NO_DEL);
        
        return userMapper.selectCount(query) > 0;
    }

    @Override
    public boolean checkEmailExists(String email) {
        if (StrUtil.isBlank(email)) {
            return false;
        }
        
        LambdaQueryWrapper<User> query = new LambdaQueryWrapper<>();
        query.eq(User::getEmail, email);
        query.eq(User::getDelFlag, com.alicloud.dao.enums.DelFlag.NO_DEL);
        
        return userMapper.selectCount(query) > 0;
    }

    @Override
    public boolean checkPhoneNumberExists(String phoneNumber) {
        if (StrUtil.isBlank(phoneNumber)) {
            return false;
        }
        
        LambdaQueryWrapper<User> query = new LambdaQueryWrapper<>();
        query.eq(User::getPhoneNumber, phoneNumber);
        query.eq(User::getDelFlag, com.alicloud.dao.enums.DelFlag.NO_DEL);
        
        return userMapper.selectCount(query) > 0;
    }
}
```

## 4. 注册控制器

```java
// ali-cloud-authService/src/main/java/com/alicloud/auth/controller/RegisterController.java
package com.alicloud.auth.controller;

import com.alicloud.api.bean.dto.UserRegisterDto;
import com.alicloud.api.service.user.RegisterService;
import com.alicloud.common.model.CommonResponse;
import com.alicloud.common.model.RegisterResponse;
import com.alicloud.common.utils.CommonUtil;
import com.alicloud.common.utils.IpUtils;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.annotation.Resource;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
import lombok.extern.slf4j.Slf4j;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

/**
 * 用户注册控制器
 * @author: zhaolin
 * @Date: 2025/11/23
 * @Description:
 */
@Slf4j
@RestController
@RequestMapping("/register")
@Tag(name = "用户注册", description = "用户注册相关接口")
@Validated
public class RegisterController {

    @Resource
    private RegisterService registerService;

    @PostMapping("/captcha")
    @Operation(summary = "发送注册验证码", description = "发送邮箱或短信验证码")
    public CommonResponse<String> sendCaptcha(
            @RequestParam String email,
            @RequestParam(required = false) String captchaKey,
            HttpServletRequest request) {
        
        try {
            // 如果没有提供captchaKey，生成一个
            if (StrUtil.isBlank(captchaKey)) {
                captchaKey = CommonUtil.randomString(32);
            }
            
            boolean success = registerService.sendRegisterCaptcha(email, captchaKey);
            
            if (success) {
                return CommonResponse.<String>builder()
                        .success(captchaKey)
                        .build();
            } else {
                return CommonResponse.<String>builder()
                        .failed(500, "发送验证码失败")
                        .build();
            }
        } catch (Exception e) {
            log.error("发送注册验证码失败: email={}", email, e);
            return CommonResponse.<String>builder()
                    .failed(500, e.getMessage())
                    .build();
        }
    }

    @PostMapping("/signup")
    @Operation(summary = "用户注册", description = "用户注册接口")
    public CommonResponse<RegisterResponse> register(
            @Valid @RequestBody UserRegisterDto registerDto,
            HttpServletRequest request) {
        
        try {
            // 设置客户端信息
            registerDto.setClientIp(getClientIP(request));
            registerDto.setUserAgent(request.getHeader("User-Agent"));
            
            RegisterResponse response = registerService.register(registerDto);
            
            return CommonResponse.<RegisterResponse>builder()
                    .success(response)
                    .build();
                    
        } catch (Exception e) {
            log.error("用户注册失败: username={}", registerDto.getUsername(), e);
            return CommonResponse.<RegisterResponse>builder()
                    .failed(500, e.getMessage())
                    .build();
        }
    }

    @GetMapping("/check-username")
    @Operation(summary = "检查用户名是否存在", description = "检查用户名是否已被注册")
    public CommonResponse<Boolean> checkUsername(@RequestParam String username) {
        try {
            boolean exists = registerService.checkUsernameExists(username);
            return CommonResponse.<Boolean>builder()
                    .success(exists)
                    .build();
        } catch (Exception e) {
            log.error("检查用户名失败: username={}", username, e);
            return CommonResponse.<Boolean>builder()
                    .failed(500, "检查用户名失败")
                    .build();
        }
    }

    @GetMapping("/check-email")
    @Operation(summary = "检查邮箱是否存在", description = "检查邮箱是否已被注册")
    public CommonResponse<Boolean> checkEmail(@RequestParam String email) {
        try {
            boolean exists = registerService.checkEmailExists(email);
            return CommonResponse.<Boolean>builder()
                    .success(exists)
                    .build();
        } catch (Exception e) {
            log.error("检查邮箱失败: email={}", email, e);
            return CommonResponse.<Boolean>builder()
                    .failed(500, "检查邮箱失败")
                    .build();
        }
    }

    @GetMapping("/check-phone")
    @Operation(summary = "检查手机号是否存在", description = "检查手机号是否已被注册")
    public CommonResponse<Boolean> checkPhoneNumber(@RequestParam String phoneNumber) {
        try {
            boolean exists = registerService.checkPhoneNumberExists(phoneNumber);
            return CommonResponse.<Boolean>builder()
                    .success(exists)
                    .build();
        } catch (Exception e) {
            log.error("检查手机号失败: phone={}", phoneNumber, e);
            return CommonResponse.<Boolean>builder()
                    .failed(500, "检查手机号失败")
                    .build();
        }
    }

    private String getClientIP(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }

        String xRealIP = request.getHeader("X-Real-IP");
        if (xRealIP != null && !xRealIP.isEmpty()) {
            return xRealIP;
        }

        return request.getRemoteAddr();
    }
}
```

## 5. 安全配置更新

```java
// ali-cloud-authService/src/main/java/com/alicloud/auth/config/SecurityConfig.java
package com.alicloud.auth.config;

import com.alicloud.auth.filter.JwtAuthenticationTokenFilter;
import com.alicloud.auth.handler.DeniedAccessExceptionHandler;
import jakarta.annotation.Resource;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {

    @Resource
    JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;

    @Resource
    AuthenticationEntryPoint authenticationEntryPoint;

    @Resource
    DeniedAccessExceptionHandler deniedAccessExceptionHandler;

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12);
    }

    @Bean
    public AuthenticationManager authenticationManager(
        AuthenticationConfiguration authenticationConfiguration
    ) throws Exception {
        return authenticationConfiguration.getAuthenticationManager();
    }

    @Bean
    public SecurityFilterChain configure(HttpSecurity http) throws Exception {
        http
            // 禁用CSRF保护
            .csrf(AbstractHttpConfigurer::disable)
            .sessionManagement(sessionManagerConfig -> {
                sessionManagerConfig.sessionCreationPolicy(
                    SessionCreationPolicy.STATELESS
                );
            })
            .authorizeHttpRequests(
                authorizationManagerRequestMatcherRegistry -> {
                    authorizationManagerRequestMatcherRegistry
                        // 允许Nacos相关请求匿名访问
                        .requestMatchers("/nacos/**", "/actuator/**")
                        .permitAll()
                        // 登录接口可以匿名访问
                        .requestMatchers("/auth/login")
                        .anonymous()
                        // 注册相关接口允许匿名访问
                        .requestMatchers("/register/**")
                        .permitAll()
                        // 公共接口允许访问
                        .requestMatchers("/v1/public/**")
                        .permitAll()
                        // 其余的请求都需要验证
                        .anyRequest()
                        .authenticated();
                }
            );

        // 增加鉴权异常处理器
        http
            .addFilterBefore(
                jwtAuthenticationTokenFilter,
                UsernamePasswordAuthenticationFilter.class
            )
            .exceptionHandling(httpSecurityExceptionHandlingConfigurer -> {
                httpSecurityExceptionHandlingConfigurer
                    .authenticationEntryPoint(authenticationEntryPoint)
                    .accessDeniedHandler(deniedAccessExceptionHandler);
            });
        return http.build();
    }
}
```

## 6. 邮件配置（可选）

```yaml
# ali-cloud-authService/src/main/resources/dev/application.yml
spring:
  mail:
    host: smtp.163.com
    port: 587
    username: your-email@163.com
    password: your-email-password
    protocol: smtp
    default-encoding: UTF-8
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
          socketFactory:
            class: javax.net.ssl.SSLSocketFactory
            port: 465
```

## 7. 测试用例

```java
// 注册功能测试
// 发送验证码
POST http://localhost:8011/register/captcha?email=test@example.com

// 用户注册
POST http://localhost:8011/register/signup
Content-Type: application/json

{
    "username": "testuser",
    "password": "Test123456",
    "confirmPassword": "Test123456",
    "nickname": "测试用户",
    "email": "test@example.com",
    "phoneNumber": "13800138000",
    "captcha": "123456",
    "captchaKey": "generated-captcha-key"
}

// 检查用户名是否存在
GET http://localhost:8011/register/check-username?username=testuser

// 检查邮箱是否存在
GET http://localhost:8011/register/check-email?email=test@example.com
```

## 8. 前端集成示例

```javascript
// 前端注册表单示例
const registerForm = {
    username: '',
    password: '',
    confirmPassword: '',
    nickname: '',
    email: '',
    phoneNumber: '',
    captcha: '',
    captchaKey: ''
};

// 发送验证码
const sendCaptcha = async () => {
    try {
        const response = await fetch('/register/captcha', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: registerForm.email
            })
        });
        
        const result = await response.json();
        if (result.code === 0) {
            registerForm.captchaKey = result.data;
            alert('验证码已发送，请查收邮箱');
        }
    } catch (error) {
        console.error('发送验证码失败:', error);
    }
};

// 用户注册
const register = async () => {
    try {
        const response = await fetch('/register/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(registerForm)
        });
        
        const result = await response.json();
        if (result.code === 0) {
            alert('注册成功！');
            // 跳转到登录页面
            window.location.href = '/login';
        } else {
            alert(result.message || '注册失败');
        }
    } catch (error) {
        console.error('注册失败:', error);
    }
};
```

这套注册功能提供了完整的安全注册流程，包括参数验证、验证码、密码加密、用户存在性检查等功能，与您现有的认证架构完美集成。